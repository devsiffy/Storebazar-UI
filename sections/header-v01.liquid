<style>
  :root {
    --header-height: 60px;
    --header-group-height: var(--header-height);
    --transparent-header-offset-boolean: 0;
    --header-transition-speed: 0.3s;
    --header-transition-easing: cubic-bezier(0.4, 0, 0.2, 1);
  }

  body {
    --header-height: 60px;
    --header-group-height: var(--header-height);
    --transparent-header-offset-boolean: 0;
  }

  .header {
    display: block;
    contain: layout style;
    will-change: transform, opacity;
  }

  .header-section {
    position: relative;
    z-index: 9999 !important;
  }

  /* Sticky Header */
  #header-group:has(#header-component[sticky]) {
    display: contents;
  }

  .header-section:has(> #header-component[sticky='always']) {
    position: sticky;
    top: -1px;
    z-index: 1000;
  }

  .header-section:has(> #header-component[sticky='scroll-up'][data-sticky-state='active']) {
    position: sticky;
    top: -1px;
    z-index: 1000;
  }

  .header[sticky='always'],
  .header[sticky='scroll-up'] {
    transition: opacity 0.3s ease, 
                box-shadow var(--header-transition-speed) ease,
                transform var(--header-transition-speed) var(--header-transition-easing);
  }

  .header[sticky='always'][data-sticky-state='active'],
  .header[sticky='scroll-up'][data-sticky-state='active'] {
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
  }

  .header[data-sticky-state] {
    opacity: 1;
  }

  .header[data-sticky-state='idle'] {
    opacity: 0;
    pointer-events: none;
  }

  /* Header Row */
  .header__row {
    position: relative;
    background-color: rgb(255, 255, 255);
  }

  .section {
    padding: 0;
  }

  .section--full-width-margin {
    margin: 0;
  }

  .section--full-width {
    max-width: 100%;
  }

  .section--page-width {
    max-width: 1200px;
    margin-left: auto;
    margin-right: auto;
  }

  .header__columns {
    display: grid;
    grid-template-areas: 'left center right';
    gap: 16px;
    grid-template-columns: minmax(40px, auto) 1fr minmax(auto, max-content);
    align-items: center;
    padding: 16px 24px;
  }

  .spacing-style {
    /* Add any spacing styles if needed */
  }

  /* Mobile Layout Optimization */
  @media screen and (max-width: 749px) {
    body {
      --header-height: 56px;
    }

    .header__columns {
      grid-template-columns: minmax(40px, auto) 1fr minmax(auto, max-content);
      gap: 12px;
      padding: 12px 16px;
    }

    .header__column--left {
      min-width: 40px;
      max-width: fit-content;
    }

    .header__column--center {
      min-width: 0;
      overflow: visible;
      justify-self: center;
    }

    .header__column--right {
      min-width: auto;
      flex-shrink: 0;
      justify-self: end;
    }
  }

  /* Tablet adjustments */
  @media screen and (min-width: 750px) and (max-width: 989px) {
    .header__columns {
      padding: 16px 20px;
    }
  }

  .header__column {
    display: flex;
    align-items: center;
  }

  .header__column--left {
    grid-area: left;
    justify-content: flex-start;
  }

  .header__column--center {
    grid-area: center;
    justify-content: center;
  }

  .header__column--right {
    grid-area: right;
    justify-content: flex-end;
  }

  /* Menu Button */
  .header__icon--menu {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 40px;
    height: 40px;
    min-width: 40px;
    padding: 0;
    border: none;
    background: transparent;
    cursor: pointer;
    border-radius: 4px;
    transition: background-color 0.2s ease;
    flex-shrink: 0;
    -webkit-tap-highlight-color: transparent;
    color: rgb(18, 18, 18);
  }

  .button-unstyled {
    background: none;
    border: none;
    padding: 0;
    margin: 0;
  }

  .header__icon--menu:hover {
    background: rgba(18, 18, 18, 0.05);
  }

  .header__icon--menu:focus-visible {
    outline: 2px solid rgb(18, 18, 18);
    outline-offset: 2px;
  }

  @media screen and (max-width: 749px) {
    .header__icon--menu {
      width: 36px;
      height: 36px;
      min-width: 36px;
    }
  }

  .svg-wrapper {
    display: inline-flex;
    align-items: center;
    justify-content: center;
  }

  /* Logo Styling */
  .header-logo {
    line-height: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    width: 100%;
    max-width: 100%;
  }

  .logo {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    line-height: 0;
    max-width: 100%;
    text-decoration: none;
    transition: opacity 0.2s ease;
    color: rgb(18, 18, 18);
  }

  .logo:hover {
    opacity: 0.8;
  }

  .logo:focus-visible {
    outline: 2px solid rgb(18, 18, 18);
    outline-offset: 4px;
    border-radius: 4px;
  }

  .header-logo__image {
    max-width: var(--logo-max-width, 150px);
    width: auto;
    height: auto;
    max-height: var(--logo-max-height, 70px);
    object-fit: contain;
    display: block;
  }

  /* Mobile Logo Sizing */
  @media screen and (max-width: 749px) {
    .header-logo__image {
      max-width: min(var(--logo-max-width, 150px), calc(100vw - 180px));
      max-height: 50px;
      width: auto;
    }

    .logo__text {
      font-size: clamp(14px, 4vw, 18px);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: calc(100vw - 180px);
    }
  }

  /* Tablet Logo Sizing */
  @media screen and (min-width: 750px) and (max-width: 989px) {
    .header-logo__image {
      max-width: var(--logo-max-width, 150px);
      max-height: 60px;
    }
  }

  .logo__text {
    display: block;
    font-size: 20px;
    font-weight: 600;
    letter-spacing: -0.02em;
    white-space: nowrap;
    color: rgb(18, 18, 18);
    font-family: "Libre Caslon Display", serif;
  }

  /* Header Actions */
  .header-actions-custom {
    display: flex;
    align-items: center;
    gap: 6px;
  }

  @media screen and (min-width: 750px) {
    .header-actions-custom {
      gap: 8px;
    }
  }

  .header-actions__action {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    position: relative;
    width: 40px;
    height: 40px;
    min-width: 40px;
    padding: 0;
    border: none;
    background: transparent;
    color: rgb(18, 18, 18);
    cursor: pointer;
    border-radius: 4px;
    text-decoration: none;
    transition: background-color 0.2s ease;
    flex-shrink: 0;
    -webkit-tap-highlight-color: transparent;
  }

  @media screen and (max-width: 749px) {
    .header-actions__action {
      width: 36px;
      height: 36px;
      min-width: 36px;
    }

    .header-actions__action .svg-wrapper svg {
      width: 20px;
      height: 20px;
    }
  }

  .header-actions__action:hover {
    background: rgba(18, 18, 18, 0.05);
  }

  .header-actions__action:focus-visible {
    outline: 2px solid rgb(18, 18, 18);
    outline-offset: 2px;
  }

  /* Cart Icon with Badge */
  .header-actions__action--cart {
    position: relative;
  }

  .cart-count-bubble {
    position: absolute;
    top: 0;
    right: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    min-width: 18px;
    height: 18px;
    padding: 0 5px;
    background-color: rgb(230, 95, 50);
    color: rgb(255, 255, 255);
    border-radius: 50%;
    font-size: 11px;
    font-weight: 600;
    line-height: 1;
    pointer-events: none;
    transform: translate(25%, -25%);
    transition: transform 0.2s ease, opacity 0.2s ease;
    font-family: "Inter", sans-serif;
  }

  @media screen and (max-width: 749px) {
    .cart-count-bubble {
      min-width: 16px;
      height: 16px;
      font-size: 10px;
      padding: 0 4px;
    }
  }

  .cart-count-bubble[hidden] {
    display: none;
  }

  .cart-count-bubble__text {
    display: block;
  }

  /* Cart bubble animation */
  .cart-count-bubble--animating {
    animation: cart-bubble-pulse 0.4s cubic-bezier(0.4, 0, 0.2, 1);
  }

  @keyframes cart-bubble-pulse {
    0% {
      transform: translate(25%, -25%) scale(1);
    }
    50% {
      transform: translate(25%, -25%) scale(1.3);
    }
    100% {
      transform: translate(25%, -25%) scale(1);
    }
  }

  /* Side Navigation Overlay */
  .side-nav-overlay {
    position: fixed;
    inset: 0;
    background: rgba(18, 18, 18, 0.5);
    z-index: 999;
    opacity: 0;
    transition: opacity var(--header-transition-speed) ease;
    -webkit-backdrop-filter: blur(2px);
    backdrop-filter: blur(2px);
  }

  .side-nav-overlay[data-visible] {
    opacity: 1;
  }

  /* Side Navigation */
  .side-nav {
    position: fixed;
    top: 0;
    left: 0;
    bottom: 0;
    width: min(360px, 85vw);
    background: rgb(255, 255, 255);
    z-index: 1000;
    display: flex;
    flex-direction: column;
    transform: translateX(-100%);
    transition: transform var(--header-transition-speed) var(--header-transition-easing);
    box-shadow: 2px 0 20px rgba(18, 18, 18, 0.15);
    overscroll-behavior: contain;
  }

  .side-nav[data-open] {
    transform: translateX(0);
  }

  .side-nav__header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 20px 24px;
    border-bottom: 1px solid rgb(215, 205, 190);
    flex-shrink: 0;
    min-height: 72px;
  }

  .side-nav__logo {
    display: block;
    line-height: 0;
    text-decoration: none;
    transition: opacity 0.2s ease;
  }

  .side-nav__logo:hover {
    opacity: 0.8;
  }

  .side-nav__logo:focus-visible {
    outline: 2px solid rgb(18, 18, 18);
    outline-offset: 2px;
    border-radius: 4px;
  }

  .side-nav__logo img {
    max-height: 32px;
    width: auto;
    display: block;
  }

  .side-nav__logo .logo__text {
    font-size: 18px;
  }

  .side-nav__close {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 40px;
    height: 40px;
    min-width: 40px;
    padding: 0;
    border: none;
    background: transparent;
    cursor: pointer;
    border-radius: 4px;
    transition: background-color 0.2s ease;
    -webkit-tap-highlight-color: transparent;
    color: rgb(18, 18, 18);
  }

  .side-nav__close:hover {
    background: rgba(18, 18, 18, 0.05);
  }

  .side-nav__close:focus-visible {
    outline: 2px solid rgb(18, 18, 18);
    outline-offset: 2px;
  }

  .side-nav__viewport {
    position: relative;
    flex: 1;
    overflow: hidden;
  }

  .side-nav__panel {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgb(255, 255, 255);
    overflow-y: auto;
    overflow-x: hidden;
    -webkit-overflow-scrolling: touch;
    transform: translateX(100%);
    transition: transform var(--header-transition-speed) var(--header-transition-easing),
                opacity var(--header-transition-speed) ease;
    opacity: 0;
    visibility: hidden;
    overscroll-behavior: contain;
  }

  .side-nav__panel[data-active] {
    transform: translateX(0);
    opacity: 1;
    visibility: visible;
    position: relative;
  }

  .side-nav__panel[data-previous] {
    transform: translateX(-30%);
    opacity: 0.3;
    visibility: visible;
    position: absolute;
  }

  .side-nav__panel-header {
    padding: 0;
    border-bottom: 1px solid rgb(215, 205, 190);
    background: rgb(250, 250, 250);
    position: sticky;
    top: 0;
    z-index: 1;
  }

  .side-nav__back {
    display: flex;
    align-items: center;
    gap: 8px;
    width: 100%;
    padding: 16px 24px;
    border: none;
    background: transparent;
    font-size: 15px;
    font-weight: 500;
    color: rgb(18, 18, 18);
    cursor: pointer;
    text-align: left;
    transition: background-color 0.2s ease;
    -webkit-tap-highlight-color: transparent;
    font-family: "Inter", sans-serif;
  }

  .side-nav__back:hover {
    background: rgba(18, 18, 18, 0.03);
  }

  .side-nav__back:focus-visible {
    outline: 2px solid rgb(18, 18, 18);
    outline-offset: -2px;
  }

  .side-nav__back svg {
    flex-shrink: 0;
  }

  .side-nav__menu {
    list-style: none;
    margin: 0;
    padding: 0;
  }

  .side-nav__item {
    margin: 0;
    border-bottom: 1px solid rgb(250, 250, 250);
  }

  .side-nav__item:last-child {
    border-bottom: none;
  }

  .side-nav__link {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 16px 24px;
    color: rgb(18, 18, 18);
    text-decoration: none;
    font-size: 15px;
    font-weight: 400;
    letter-spacing: 0.01em;
    transition: background-color 0.2s ease;
    border: none;
    background: transparent;
    width: 100%;
    text-align: left;
    cursor: pointer;
    -webkit-tap-highlight-color: transparent;
    font-family: "Inter", sans-serif;
  }

  .side-nav__link:hover {
    background: rgba(18, 18, 18, 0.02);
  }

  .side-nav__link:focus-visible {
    outline: 2px solid rgb(18, 18, 18);
    outline-offset: -2px;
    background: rgba(18, 18, 18, 0.03);
  }

  .side-nav__link--parent {
    font-weight: 500;
  }

  .side-nav__arrow {
    flex-shrink: 0;
    opacity: 0.5;
    transition: opacity 0.2s ease;
  }

  .side-nav__link--parent:hover .side-nav__arrow {
    opacity: 1;
  }

  /* Body scroll lock */
  body.menu-open {
    overflow: hidden;
    position: fixed;
    width: 100%;
    height: 100%;
  }

  /* Mobile specific adjustments */
  @media (max-width: 768px) {
    .side-nav {
      width: min(320px, 85vw);
    }

    .side-nav__link {
      padding: 14px 20px;
      font-size: 14px;
    }

    .side-nav__back {
      padding: 14px 20px;
      font-size: 14px;
    }

    .side-nav__header {
      padding: 16px 20px;
      min-height: 64px;
    }
  }

  /* Accessibility - Visually Hidden */
  .visually-hidden {
    position: absolute;
    width: 1px;
    height: 1px;
    margin: -1px;
    padding: 0;
    overflow: hidden;
    clip: rect(0, 0, 0, 0);
    clip-path: inset(50%);
    border: 0;
    white-space: nowrap;
  }

  /* Performance optimizations */
  @media (prefers-reduced-motion: reduce) {
    .header[sticky],
    .side-nav,
    .side-nav-overlay,
    .side-nav__panel,
    .header__icon--menu,
    .header-actions__action,
    .side-nav__link,
    .side-nav__back,
    .logo,
    .cart-count-bubble {
      transition: none !important;
      animation: none !important;
    }
  }

  /* High contrast mode support */
  @media (prefers-contrast: high) {
    .header__icon--menu:hover,
    .header-actions__action:hover,
    .side-nav__link:hover,
    .side-nav__back:hover {
      outline: 2px solid rgb(18, 18, 18);
    }
  }
</style>

{% liquid
  assign drawer_menu = section.settings.drawer_menu | default: 'main-menu'
  
  if section.settings.enable_sticky_header == 'always'
    assign sticky = 'always'
  elsif section.settings.enable_sticky_header == 'scroll-up'
    assign sticky = 'scroll-up'
  else
    assign sticky = 'never'
  endif

  assign transparent = false

  if section.settings.enable_transparent_header_home and template.name == 'index'
    assign transparent = 'always'
  elsif section.settings.enable_transparent_header_product and template.name == 'product'
    assign transparent = 'always'
  elsif section.settings.enable_transparent_header_collection and template.name == 'collection'
    assign transparent = 'always'
  endif

  if transparent and sticky != 'never'
    assign transparent = 'not-sticky'
  endif

  assign logo_image = section.settings.logo
  if logo_image == blank
    assign logo_image = settings.logo
  endif

  assign header_class = 'header'
  if transparent
    assign header_class = header_class | append: ' header--transparent'
  endif

  comment
    Calculate logo dimensions for width/height attributes
  endcomment
  assign logo_width = section.settings.logo_width | default: 150
  if logo_image != blank
    assign logo_aspect_ratio = logo_image.aspect_ratio | default: 3.0
    assign logo_height = logo_width | divided_by: logo_aspect_ratio | round
  else
    assign logo_height = 40
  endif
%}

<script type="application/ld+json">
  {
    "@context": "http://schema.org",
    "@type": "Organization",
    "name": {{ shop.name | json }},
    {% if logo_image %}
      "logo": {{ logo_image | image_url: width: 500 | prepend: "https:" | json }},
    {% endif %}
    "url": {{ request.origin | append: page.url | json }}
  }
</script>

<header-component
  id="header-component"
  class="{{ header_class }}"
  data-section-id="{{ section.id }}"
  {% if transparent %}
    transparent="{{ transparent }}"
  {% endif %}
  {% if sticky and sticky != 'never' %}
    sticky="{{ sticky }}"
  {% endif %}
  data-scroll-direction="none"
  style="--logo-max-width: {{ logo_width }}px; --logo-max-height: {{ logo_height }}px;"
>
  {% if request.page_type == 'index' %}
    <h1 class="visually-hidden">{{ shop.name }}</h1>
  {% endif %}

  <div class="header__row header__row--top section section--full-width-margin section--{{ section.settings.section_width }}">
    <div class="header__columns spacing-style">
      {%- comment -%} LEFT: Menu Button {%- endcomment -%}
      <div class="header__column header__column--left">
        <button
          type="button"
          class="header__icon--menu button button-unstyled"
          aria-label="Open navigation menu"
          aria-expanded="false"
          aria-controls="side-nav"
          data-menu-toggle
        >
          <span class="svg-wrapper" aria-hidden="true">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" role="img">
              <title>Menu</title>
              <line x1="3" y1="12" x2="21" y2="12"></line>
              <line x1="3" y1="6" x2="21" y2="6"></line>
              <line x1="3" y1="18" x2="21" y2="18"></line>
            </svg>
          </span>
        </button>
      </div>

      {%- comment -%} CENTER: Logo {%- endcomment -%}
      <div class="header__column header__column--center">
        <div class="header-logo">
          <a href="{{ routes.root_url }}" class="logo" aria-label="Go to homepage">
            {% if logo_image != blank %}
              <img
                src="{{ logo_image | image_url: width: logo_width }}"
                srcset="{{ logo_image | image_url: width: logo_width }} 1x, {{ logo_image | image_url: width: logo_width | times: 2 }} 2x"
                alt="{{ shop.name }}"
                width="{{ logo_width }}"
                height="{{ logo_height }}"
                loading="eager"
                fetchpriority="high"
                class="header-logo__image"
              >
            {% else %}
              <span class="logo__text">{{ shop.name }}</span>
            {% endif %}
          </a>
        </div>
      </div>

      {%- comment -%} RIGHT: Actions {%- endcomment -%}
      <div class="header__column header__column--right">
        <div class="header-actions-custom">
          {% if section.settings.show_search %}
            <button
              type="button"
              class="header-actions__action header-actions__action--search"
              aria-label="Open search"
            >
              <span class="svg-wrapper" aria-hidden="true">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" role="img">
                  <title>Search</title>
                  <circle cx="11" cy="11" r="8"></circle>
                  <path d="m21 21-4.35-4.35"></path>
                </svg>
              </span>
            </button>
          {% endif %}

          {% if section.settings.show_account and shop.customer_accounts_enabled %}
            <a 
              href="{{ routes.account_url }}" 
              class="header-actions__action header-actions__action--account"
              aria-label="Go to account page"
            >
              <span class="svg-wrapper" aria-hidden="true">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" role="img">
                  <title>Account</title>
                  <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                  <circle cx="12" cy="7" r="4"></circle>
                </svg>
              </span>
            </a>
          {% endif %}

          {% if section.settings.show_cart %}
            <a 
              href="{{ routes.cart_url }}" 
              class="header-actions__action header-actions__action--cart"
              aria-label="Open cart"
              data-cart-icon
            >
              <span class="svg-wrapper" aria-hidden="true">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" role="img">
                  <title>Cart</title>
                  <circle cx="9" cy="21" r="1"></circle>
                  <circle cx="20" cy="21" r="1"></circle>
                  <path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"></path>
                </svg>
              </span>
              <span 
                class="cart-count-bubble"
                data-cart-bubble
                {% if cart.item_count == 0 %}hidden{% endif %}
              >
                <span class="visually-hidden">Cart items count:</span>
                <span class="cart-count-bubble__text" data-cart-count>{{ cart.item_count }}</span>
              </span>
            </a>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
</header-component>

{%- comment -%} Side Navigation Overlay {%- endcomment -%}
<div class="side-nav-overlay" data-menu-overlay hidden aria-hidden="true"></div>

{%- comment -%} Side Navigation Drawer {%- endcomment -%}
<nav 
  id="side-nav"
  class="side-nav" 
  data-side-nav 
  aria-label="Main navigation"
  role="navigation"
>
  <div class="side-nav__header">
    {% if section.settings.show_logo_in_menu %}
      <a href="{{ routes.root_url }}" class="side-nav__logo" aria-label="Go to homepage">
        {% if logo_image != blank %}
          {% assign menu_logo_width = 150 %}
          {% assign menu_logo_height = menu_logo_width | divided_by: logo_aspect_ratio | round %}
          <img
            src="{{ logo_image | image_url: width: menu_logo_width }}"
            alt="{{ shop.name }}"
            width="{{ menu_logo_width }}"
            height="{{ menu_logo_height }}"
            loading="lazy"
          >
        {% else %}
          <span class="logo__text">{{ shop.name }}</span>
        {% endif %}
      </a>
    {% endif %}
    <button
      type="button"
      class="side-nav__close"
      aria-label="Close navigation menu"
      data-menu-close
    >
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" role="img" aria-hidden="true">
        <title>Close</title>
        <line x1="18" y1="6" x2="6" y2="18"></line>
        <line x1="6" y1="6" x2="18" y2="18"></line>
      </svg>
    </button>
  </div>

  <div class="side-nav__viewport" data-viewport>
    {%- comment -%} Main Menu Level {%- endcomment -%}
    <div class="side-nav__panel" data-panel="main" data-active>
      <ul class="side-nav__menu" role="list">
        {% for link in linklists[drawer_menu].links %}
          <li class="side-nav__item">
            {% if link.links.size > 0 %}
              <button 
                type="button"
                class="side-nav__link side-nav__link--parent"
                data-menu-trigger="{{ link.handle }}"
                aria-label="Open {{ link.title }} submenu"
              >
                <span>{{ link.title }}</span>
                <svg class="side-nav__arrow" width="20" height="20" viewBox="0 0 20 20" aria-hidden="true">
                  <path d="M7 5l5 5-5 5" stroke="currentColor" stroke-width="2" fill="none"/>
                </svg>
              </button>
            {% else %}
              <a href="{{ link.url }}" class="side-nav__link">
                {{ link.title }}
              </a>
            {% endif %}
          </li>
        {% endfor %}
      </ul>
    </div>

    {%- comment -%} Generate nested panels - Level 2 {%- endcomment -%}
    {% for link in linklists[drawer_menu].links %}
      {% if link.links.size > 0 %}
        <div class="side-nav__panel" data-panel="{{ link.handle }}">
          <div class="side-nav__panel-header">
            <button 
              type="button" 
              class="side-nav__back"
              data-back-trigger
              aria-label="Go back to previous menu"
            >
              <svg width="20" height="20" viewBox="0 0 20 20" aria-hidden="true">
                <path d="M13 15l-5-5 5-5" stroke="currentColor" stroke-width="2" fill="none"/>
              </svg>
              <span>{{ link.title }}</span>
            </button>
          </div>
          <ul class="side-nav__menu" role="list">
            {% for child_link in link.links %}
              <li class="side-nav__item">
                {% if child_link.links.size > 0 %}
                  <button 
                    type="button"
                    class="side-nav__link side-nav__link--parent"
                    data-menu-trigger="{{ link.handle }}-{{ child_link.handle }}"
                    aria-label="Open {{ child_link.title }} submenu"
                  >
                    <span>{{ child_link.title }}</span>
                    <svg class="side-nav__arrow" width="20" height="20" viewBox="0 0 20 20" aria-hidden="true">
                      <path d="M7 5l5 5-5 5" stroke="currentColor" stroke-width="2" fill="none"/>
                    </svg>
                  </button>
                {% else %}
                  <a href="{{ child_link.url }}" class="side-nav__link">
                    {{ child_link.title }}
                  </a>
                {% endif %}
              </li>
            {% endfor %}
          </ul>
        </div>

        {%- comment -%} Third level nested panels {%- endcomment -%}
        {% for child_link in link.links %}
          {% if child_link.links.size > 0 %}
            <div class="side-nav__panel" data-panel="{{ link.handle }}-{{ child_link.handle }}">
              <div class="side-nav__panel-header">
                <button 
                  type="button" 
                  class="side-nav__back"
                  data-back-trigger
                  aria-label="Go back to previous menu"
                >
                  <svg width="20" height="20" viewBox="0 0 20 20" aria-hidden="true">
                    <path d="M13 15l-5-5 5-5" stroke="currentColor" stroke-width="2" fill="none"/>
                  </svg>
                  <span>{{ child_link.title }}</span>
                </button>
              </div>
              <ul class="side-nav__menu" role="list">
                {% for grandchild_link in child_link.links %}
                  <li class="side-nav__item">
                    {% if grandchild_link.links.size > 0 %}
                      <button 
                        type="button"
                        class="side-nav__link side-nav__link--parent"
                        data-menu-trigger="{{ link.handle }}-{{ child_link.handle }}-{{ grandchild_link.handle }}"
                        aria-label="Open {{ grandchild_link.title }} submenu"
                      >
                        <span>{{ grandchild_link.title }}</span>
                        <svg class="side-nav__arrow" width="20" height="20" viewBox="0 0 20 20" aria-hidden="true">
                          <path d="M7 5l5 5-5 5" stroke="currentColor" stroke-width="2" fill="none"/>
                        </svg>
                      </button>
                    {% else %}
                      <a href="{{ grandchild_link.url }}" class="side-nav__link">
                        {{ grandchild_link.title }}
                      </a>
                    {% endif %}
                  </li>
                {% endfor %}
              </ul>
            </div>

            {%- comment -%} Fourth level nested panels {%- endcomment -%}
            {% for grandchild_link in child_link.links %}
              {% if grandchild_link.links.size > 0 %}
                <div class="side-nav__panel" data-panel="{{ link.handle }}-{{ child_link.handle }}-{{ grandchild_link.handle }}">
                  <div class="side-nav__panel-header">
                    <button 
                      type="button" 
                      class="side-nav__back"
                      data-back-trigger
                      aria-label="Go back to previous menu"
                    >
                      <svg width="20" height="20" viewBox="0 0 20 20" aria-hidden="true">
                        <path d="M13 15l-5-5 5-5" stroke="currentColor" stroke-width="2" fill="none"/>
                      </svg>
                      <span>{{ grandchild_link.title }}</span>
                    </button>
                  </div>
                  <ul class="side-nav__menu" role="list">
                    {% for great_grandchild_link in grandchild_link.links %}
                      <li class="side-nav__item">
                        <a href="{{ great_grandchild_link.url }}" class="side-nav__link">
                          {{ great_grandchild_link.title }}
                        </a>
                      </li>
                    {% endfor %}
                  </ul>
                </div>
              {% endif %}
            {% endfor %}
          {% endif %}
        {% endfor %}
      {% endif %}
    {% endfor %}
  </div>
</nav>

<script>
(function() {
  'use strict';

  /**
   * HeaderComponent - Custom Web Component for header functionality
   */
  class HeaderComponent extends HTMLElement {
    constructor() {
      super();
      this.menuDrawerHiddenWidth = null;
      this.intersectionObserver = null;
      this.offscreen = false;
      this.lastScrollTop = 0;
      this.timeout = null;
      this.scrollRafId = null;
      this.animationDelay = 150;
      this.resizeObserver = null;
    }

    connectedCallback() {
      this.initResizeObserver();
      this.initStickyBehavior();
    }

    disconnectedCallback() {
      if (this.resizeObserver) {
        this.resizeObserver.disconnect();
      }
      if (this.intersectionObserver) {
        this.intersectionObserver.disconnect();
      }
      document.removeEventListener('scroll', this.handleScroll);
      if (this.scrollRafId !== null) {
        cancelAnimationFrame(this.scrollRafId);
      }
      document.body.style.setProperty('--header-height', '0px');
    }

    initResizeObserver() {
      var self = this;
      this.resizeObserver = new ResizeObserver(function(entries) {
        var entry = entries[0];
        if (!entry || !entry.borderBoxSize || !entry.borderBoxSize[0]) return;

        var roundedHeaderHeight = Math.round(entry.borderBoxSize[0].blockSize);
        document.body.style.setProperty('--header-height', roundedHeaderHeight + 'px');

        if (self.menuDrawerHiddenWidth && window.innerWidth > self.menuDrawerHiddenWidth) {
          self.updateMenuVisibility(false);
        }
      });

      this.resizeObserver.observe(this);
    }

    initStickyBehavior() {
      var stickyMode = this.getAttribute('sticky');
      if (!stickyMode) return;

      this.observeStickyPosition(stickyMode === 'always');

      if (stickyMode === 'scroll-up' || stickyMode === 'always') {
        var self = this;
        this.handleScroll = function() {
          self.handleScrollEvent();
        };
        document.addEventListener('scroll', this.handleScroll, { passive: true });
      }
    }

    observeStickyPosition(alwaysSticky) {
      if (this.intersectionObserver) return;

      var self = this;
      var config = {
        threshold: alwaysSticky ? 1 : 0,
      };

      this.intersectionObserver = new IntersectionObserver(function(entries) {
        var entry = entries[0];
        if (!entry) return;

        var isIntersecting = entry.isIntersecting;

        if (alwaysSticky) {
          self.dataset.stickyState = isIntersecting ? 'inactive' : 'active';
        } else {
          self.offscreen = !isIntersecting || self.dataset.stickyState === 'active';
        }
      }, config);

      this.intersectionObserver.observe(this);
    }

    handleScrollEvent() {
      if (this.scrollRafId !== null) return;

      var self = this;
      this.scrollRafId = requestAnimationFrame(function() {
        self.scrollRafId = null;
        self.updateScrollState();
      });
    }

    updateScrollState() {
      var stickyMode = this.getAttribute('sticky');
      if (!this.offscreen && stickyMode !== 'always') return;

      var scrollTop = (document.scrollingElement && document.scrollingElement.scrollTop) || 0;
      var headerTop = this.getBoundingClientRect().top;
      var isScrollingUp = scrollTop < this.lastScrollTop;
      var isAtTop = headerTop >= 0;

      if (this.timeout) {
        clearTimeout(this.timeout);
        this.timeout = null;
      }

      if (stickyMode === 'always') {
        if (isAtTop) {
          this.dataset.scrollDirection = 'none';
        } else if (isScrollingUp) {
          this.dataset.scrollDirection = 'up';
        } else {
          this.dataset.scrollDirection = 'down';
        }

        this.lastScrollTop = scrollTop;
        return;
      }

      if (isScrollingUp) {
        this.removeAttribute('data-animating');

        if (isAtTop) {
          this.offscreen = false;
          this.dataset.stickyState = 'inactive';
          this.dataset.scrollDirection = 'none';
        } else {
          this.dataset.stickyState = 'active';
          this.dataset.scrollDirection = 'up';
        }
      } else if (this.dataset.stickyState === 'active') {
        this.dataset.scrollDirection = 'none';
        this.setAttribute('data-animating', '');

        var self = this;
        this.timeout = setTimeout(function() {
          self.dataset.stickyState = 'idle';
          self.removeAttribute('data-animating');
        }, this.animationDelay);
      } else {
        this.dataset.scrollDirection = 'none';
        this.dataset.stickyState = 'idle';
      }

      this.lastScrollTop = scrollTop;
    }

    updateMenuVisibility(hideMenu) {
      var headerDrawerContainer = document.querySelector('.header__column--left');
      var headerMenu = document.querySelector('.header__column--center');

      if (!headerDrawerContainer || !headerMenu) return;

      if (hideMenu) {
        headerDrawerContainer.classList.remove('desktop:hidden');
        this.menuDrawerHiddenWidth = window.innerWidth;
        headerMenu.classList.add('hidden');
      } else {
        headerDrawerContainer.classList.add('desktop:hidden');
        this.menuDrawerHiddenWidth = null;
        headerMenu.classList.remove('hidden');
      }
    }
  }

  if (!customElements.get('header-component')) {
    customElements.define('header-component', HeaderComponent);
  }

  /**
   * CartIconManager - Manages cart icon badge updates
   */
  function CartIconManager() {
    this.cartIcon = document.querySelector('[data-cart-icon]');
    this.cartBubble = document.querySelector('[data-cart-bubble]');
    this.cartCount = document.querySelector('[data-cart-count]');
    this.init();
  }

  CartIconManager.prototype.init = function() {
    if (!this.cartIcon || !this.cartBubble || !this.cartCount) {
      return;
    }

    var self = this;
    document.addEventListener('cart:updated', function(e) {
      self.handleCartUpdate(e);
    });
    
    window.addEventListener('pageshow', function(e) {
      self.handlePageShow(e);
    });

    this.ensureCartBubbleIsCorrect();
  };

  CartIconManager.prototype.handleCartUpdate = function(event) {
    var itemCount = (event.detail && event.detail.itemCount) || 0;
    var comingFromProductForm = (event.detail && event.detail.source === 'product-form');
    this.updateCartBadge(itemCount, comingFromProductForm);
  };

  CartIconManager.prototype.handlePageShow = function(event) {
    if (event.persisted) {
      this.ensureCartBubbleIsCorrect();
    }
  };

  CartIconManager.prototype.updateCartBadge = function(itemCount, animate) {
    if (!this.cartBubble || !this.cartCount) return;

    var currentCount = parseInt(this.cartCount.textContent || '0', 10);
    var newCount = itemCount;

    this.cartCount.textContent = newCount < 100 ? String(newCount) : '99+';

    if (newCount === 0) {
      this.cartBubble.setAttribute('hidden', '');
    } else {
      this.cartBubble.removeAttribute('hidden');
    }

    if (animate && newCount > 0 && newCount !== currentCount) {
      var self = this;
      this.cartBubble.classList.add('cart-count-bubble--animating');
      setTimeout(function() {
        self.cartBubble.classList.remove('cart-count-bubble--animating');
      }, 400);
    }

    this.storeCartCount(newCount);
  };

  CartIconManager.prototype.storeCartCount = function(count) {
    try {
      sessionStorage.setItem('cart-count', JSON.stringify({
        value: String(count),
        timestamp: Date.now()
      }));
    } catch (e) {
      // Session storage not available
    }
  };

  CartIconManager.prototype.ensureCartBubbleIsCorrect = function() {
    if (!this.cartCount) return;

    try {
      var sessionData = sessionStorage.getItem('cart-count');
      if (!sessionData) return;

      var data = JSON.parse(sessionData);
      var value = data.value;
      var timestamp = data.timestamp;
      var visibleCount = this.cartCount.textContent;

      if (value !== visibleCount && Date.now() - timestamp < 10000) {
        var count = parseInt(value, 10);
        if (count >= 0) {
          this.updateCartBadge(count, false);
        }
      }
    } catch (e) {
      // Invalid session data
    }
  };

  /**
   * NestedMenu - Manages the side navigation drawer
   */
  function NestedMenu() {
    this.sideNav = document.querySelector('[data-side-nav]');
    this.viewport = document.querySelector('[data-viewport]');
    this.overlay = document.querySelector('[data-menu-overlay]');
    this.menuToggle = document.querySelector('[data-menu-toggle]');
    this.menuClose = document.querySelector('[data-menu-close]');
    this.panelStack = ['main'];
    this.lastFocusedElement = null;
    
    this.init();
  }

  NestedMenu.prototype.init = function() {
    if (!this.sideNav || !this.viewport || !this.overlay) {
      return;
    }

    var self = this;
    
    if (this.menuToggle) {
      this.menuToggle.addEventListener('click', function() {
        self.open();
      });
    }
    
    if (this.menuClose) {
      this.menuClose.addEventListener('click', function() {
        self.close();
      });
    }
    
    this.overlay.addEventListener('click', function() {
      self.close();
    });

    this.viewport.addEventListener('click', function(e) {
      var trigger = e.target.closest('[data-menu-trigger]');
      var backBtn = e.target.closest('[data-back-trigger]');

      if (trigger) {
        e.preventDefault();
        var panelId = trigger.dataset.menuTrigger;
        self.navigateToPanel(panelId);
      } else if (backBtn) {
        e.preventDefault();
        self.navigateBack();
      }
    });

    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape' && self.isOpen()) {
        e.preventDefault();
        if (self.panelStack.length > 1) {
          self.navigateBack();
        } else {
          self.close();
        }
      }
    });

    this.viewport.addEventListener('click', function(e) {
      var link = e.target.closest('.side-nav__link:not([data-menu-trigger])');
      if (link && link.tagName === 'A') {
        self.close();
      }
    });
  };

  NestedMenu.prototype.open = function() {
    this.lastFocusedElement = document.activeElement;
    this.sideNav.setAttribute('data-open', '');
    this.sideNav.setAttribute('aria-hidden', 'false');
    this.overlay.setAttribute('data-visible', '');
    this.overlay.hidden = false;
    this.overlay.setAttribute('aria-hidden', 'false');
    document.body.classList.add('menu-open');
    
    if (this.menuToggle) {
      this.menuToggle.setAttribute('aria-expanded', 'true');
    }

    var self = this;
    requestAnimationFrame(function() {
      if (self.menuClose) {
        self.menuClose.focus();
      }
    });
  };

  NestedMenu.prototype.close = function() {
    this.sideNav.removeAttribute('data-open');
    this.sideNav.setAttribute('aria-hidden', 'true');
    this.overlay.removeAttribute('data-visible');
    this.overlay.setAttribute('aria-hidden', 'true');
    
    var self = this;
    setTimeout(function() {
      self.overlay.hidden = true;
    }, 300);
    
    document.body.classList.remove('menu-open');
    
    if (this.menuToggle) {
      this.menuToggle.setAttribute('aria-expanded', 'false');
    }

    setTimeout(function() {
      self.resetToMain();
    }, 300);

    if (this.lastFocusedElement) {
      this.lastFocusedElement.focus();
      this.lastFocusedElement = null;
    }
  };

  NestedMenu.prototype.navigateToPanel = function(panelId) {
    var currentPanel = this.getCurrentPanel();
    var nextPanel = this.viewport.querySelector('[data-panel="' + panelId + '"]');
    
    if (!nextPanel) {
      return;
    }

    this.panelStack.push(panelId);

    if (currentPanel) {
      currentPanel.removeAttribute('data-active');
      currentPanel.setAttribute('data-previous', '');
    }
    
    nextPanel.setAttribute('data-active', '');
    nextPanel.removeAttribute('data-previous');

    requestAnimationFrame(function() {
      var backButton = nextPanel.querySelector('[data-back-trigger]');
      if (backButton) backButton.focus();
    });
  };

  NestedMenu.prototype.navigateBack = function() {
    if (this.panelStack.length <= 1) return;

    var currentPanel = this.getCurrentPanel();
    this.panelStack.pop();
    var previousPanel = this.getCurrentPanel();

    if (currentPanel) {
      currentPanel.removeAttribute('data-active');
      currentPanel.removeAttribute('data-previous');
    }
    
    if (previousPanel) {
      previousPanel.setAttribute('data-active', '');
      previousPanel.removeAttribute('data-previous');
    }

    var self = this;
    requestAnimationFrame(function() {
      var currentPanelId = self.panelStack[self.panelStack.length - 1];
      if (currentPanelId === 'main') {
        var firstLink = previousPanel && previousPanel.querySelector('.side-nav__link');
        if (firstLink) firstLink.focus();
      } else {
        var panelName = currentPanel && currentPanel.dataset.panel;
        var trigger = previousPanel && previousPanel.querySelector('[data-menu-trigger="' + panelName + '"]');
        if (trigger) trigger.focus();
      }
    });
  };

  NestedMenu.prototype.getCurrentPanel = function() {
    var currentPanelId = this.panelStack[this.panelStack.length - 1];
    return this.viewport.querySelector('[data-panel="' + currentPanelId + '"]');
  };

  NestedMenu.prototype.resetToMain = function() {
    var allPanels = this.viewport.querySelectorAll('[data-panel]');
    for (var i = 0; i < allPanels.length; i++) {
      allPanels[i].removeAttribute('data-active');
      allPanels[i].removeAttribute('data-previous');
    }

    this.panelStack = ['main'];
    var mainPanel = this.viewport.querySelector('[data-panel="main"]');
    if (mainPanel) {
      mainPanel.setAttribute('data-active', '');
    }
  };

  NestedMenu.prototype.isOpen = function() {
    return this.sideNav.hasAttribute('data-open');
  };

  /**
   * Initialize everything when DOM is ready
   */
  function init() {
    try {
      new NestedMenu();
      new CartIconManager();
    } catch (error) {
      console.error('Header initialization failed:', error);
    }
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', init);
  } else {
    init();
  }
})();
</script>

{% schema %}
{
  "name": "Header",
  "tag": "header",
  "class": "header-section",
  "settings": [
    {
      "type": "header",
      "content": "Logo"
    },
    {
      "type": "image_picker",
      "id": "logo",
      "label": "Logo image",
      "info": "Upload your logo here (not in Theme Settings). Recommended: 400x100px PNG with transparent background"
    },
    {
      "type": "range",
      "id": "logo_width",
      "min": 80,
      "max": 300,
      "step": 10,
      "unit": "px",
      "label": "Logo width",
      "default": 150,
      "info": "Maximum width of the logo. Logo will scale proportionally."
    },
    {
      "type": "header",
      "content": "Menu"
    },
    {
      "type": "link_list",
      "id": "drawer_menu",
      "label": "Menu",
      "default": "main-menu",
      "info": "Select which menu to display in the drawer"
    },
    {
      "type": "checkbox",
      "id": "show_logo_in_menu",
      "label": "Show logo in menu drawer",
      "default": true
    },
    {
      "type": "header",
      "content": "Header Icons"
    },
    {
      "type": "checkbox",
      "id": "show_search",
      "label": "Show search icon",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "show_account",
      "label": "Show account icon",
      "default": true,
      "info": "Only visible if customer accounts are enabled"
    },
    {
      "type": "checkbox",
      "id": "show_cart",
      "label": "Show cart icon",
      "default": true,
      "info": "Shows cart icon with item count badge"
    },
    {
      "type": "header",
      "content": "Layout"
    },
    {
      "type": "select",
      "id": "section_width",
      "label": "Width",
      "options": [
        { "value": "page-width", "label": "Page Width" },
        { "value": "full-width", "label": "Full Width" }
      ],
      "default": "full-width"
    },
    {
      "type": "select",
      "id": "enable_sticky_header",
      "label": "Sticky header",
      "options": [
        { "value": "always", "label": "Always sticky" },
        { "value": "scroll-up", "label": "Sticky on scroll up" },
        { "value": "never", "label": "Not sticky" }
      ],
      "default": "always",
      "info": "Header will stick to top when scrolling"
    },
    {
      "type": "header",
      "content": "Transparent Header"
    },
    {
      "type": "paragraph",
      "content": "Transparent header overlays page content. Not compatible with sticky header."
    },
    {
      "type": "checkbox",
      "id": "enable_transparent_header_home",
      "label": "Transparent on home page",
      "default": false
    },
    {
      "type": "checkbox",
      "id": "enable_transparent_header_product",
      "label": "Transparent on product page",
      "default": false
    },
    {
      "type": "checkbox",
      "id": "enable_transparent_header_collection",
      "label": "Transparent on collection page",
      "default": false
    }
  ],
  "presets": [
    {
      "name": "Header"
    }
  ]
}
{% endschema %}
